openapi: 3.0.3
info:
  title: Underwriting Rule Engine API
  description: |
    AI-powered underwriting system with PostgreSQL-backed rule engine management.

    **Key Features:**
    - Process policy documents from S3 and generate Drools rules automatically
    - PostgreSQL database for persistent container registry
    - Customer-facing API for dynamic service discovery
    - Evaluate applications without knowing container details
    - Multi-tenant isolation with separate containers per bank+policy
    - Request tracking and analytics

    **Architecture:**
    - Customer apps query by `bank_id` + `policy_type`
    - System automatically routes to correct rule engine container
    - All requests logged to database for analytics
    - Health checking ensures high availability

  version: 2.0.0
  contact:
    name: IBM Automation
    url: https://github.com/DecisionsDev

servers:
  - url: http://localhost:9000/rule-agent
    description: Local development server

tags:
  - name: Customer API
    description: Customer-facing endpoints for service discovery and policy evaluation
  - name: Admin - Workflow
    description: Policy document processing and rule generation (Admin only)
  - name: Admin - Deployments
    description: Deployment management and monitoring (Admin only)
  - name: System
    description: System health and utilities

paths:
  # ============================================================================
  # CUSTOMER-FACING API
  # ============================================================================

  /api/v1/banks:
    get:
      tags:
        - Customer API
      summary: List all available banks
      description: Discover which banks/organizations have deployed rule engines
      operationId: listBanks
      responses:
        '200':
          description: List of active banks
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  banks:
                    type: array
                    items:
                      type: object
                      properties:
                        bank_id:
                          type: string
                          example: chase
                        bank_name:
                          type: string
                          example: Chase Bank
                        description:
                          type: string
                          example: Chase Manhattan Bank underwriting policies

  /api/v1/banks/{bank_id}/policies:
    get:
      tags:
        - Customer API
      summary: List available policies for a bank
      description: Get all policy types available for a specific bank
      operationId: listBankPolicies
      parameters:
        - name: bank_id
          in: path
          required: true
          schema:
            type: string
          example: chase
      responses:
        '200':
          description: List of available policies
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  bank_id:
                    type: string
                    example: chase
                  policies:
                    type: array
                    items:
                      type: object
                      properties:
                        policy_type_id:
                          type: string
                          example: insurance
                        policy_name:
                          type: string
                          example: Insurance Underwriting
                        description:
                          type: string
                        category:
                          type: string
                          example: insurance

  /api/v1/policies:
    get:
      tags:
        - Customer API
      summary: Query specific policy container
      description: Check if rules are deployed for a specific bank+policy combination
      operationId: queryPolicies
      parameters:
        - name: bank_id
          in: query
          required: true
          schema:
            type: string
          example: chase
        - name: policy_type
          in: query
          required: true
          schema:
            type: string
          example: insurance
      responses:
        '200':
          description: Container information
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  container:
                    $ref: '#/components/schemas/ContainerInfo'
        '404':
          description: No active container found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/evaluate-policy:
    post:
      tags:
        - Customer API
      summary: Evaluate policy application
      description: |
        **Main endpoint for customer applications to evaluate applications using deployed rules.**

        Automatically:
        - Looks up the correct container in database
        - Routes to appropriate rule engine
        - Performs health checks
        - Logs request for analytics
        - Returns decision
      operationId: evaluatePolicy
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - bank_id
                - policy_type
                - applicant
              properties:
                bank_id:
                  type: string
                  description: Bank identifier
                  example: chase
                policy_type:
                  type: string
                  description: Policy type identifier
                  example: insurance
                applicant:
                  type: object
                  description: Applicant data
                  example:
                    age: 35
                    income: 75000
                    credit_score: 720
                    employment_status: employed
                policy:
                  type: object
                  description: Policy-specific data (optional)
                  example:
                    coverage_amount: 500000
                    term_years: 20
            examples:
              insurance-application:
                summary: Insurance Application
                value:
                  bank_id: chase
                  policy_type: insurance
                  applicant:
                    age: 35
                    income: 75000
                    credit_score: 720
                    health_status: good
                    smoker: false
                  policy:
                    coverage_amount: 500000
                    term_years: 20
                    type: term_life
              loan-application:
                summary: Loan Application
                value:
                  bank_id: chase
                  policy_type: loan
                  applicant:
                    age: 42
                    income: 95000
                    credit_score: 750
                    employment_years: 10
                    debt_to_income_ratio: 0.35
                  policy:
                    loan_amount: 250000
                    loan_term_years: 15
                    purpose: home_purchase
      responses:
        '200':
          description: Decision returned successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EvaluationResult'
        '404':
          description: No rules deployed for this bank+policy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Rule container unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/discovery:
    get:
      tags:
        - Customer API
      summary: Service discovery
      description: Get all banks with their available policies in one call
      operationId: serviceDiscovery
      responses:
        '200':
          description: Complete service catalog
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  services:
                    type: array
                    items:
                      type: object
                      properties:
                        bank_id:
                          type: string
                        bank_name:
                          type: string
                        available_policies:
                          type: array
                          items:
                            type: string
                        total_containers:
                          type: integer

  # ============================================================================
  # ADMIN API - WORKFLOW
  # ============================================================================

  /process_policy_from_s3:
    post:
      tags:
        - Admin - Workflow
      summary: Process policy document from S3
      description: |
        **Admin endpoint:** Process a policy PDF from S3 and generate rules.

        Workflow:
        1. Extract text from S3 PDF
        2. LLM analyzes and generates extraction queries
        3. AWS Textract extracts structured data
        4. LLM generates DRL rules
        5. Deploy to Drools KIE Server
        6. Upload artifacts to S3
        7. Register in PostgreSQL database
      operationId: processPolicyFromS3
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - s3_url
                - policy_type
                - bank_id
              properties:
                s3_url:
                  type: string
                  format: uri
                  example: s3://bucket/policies/chase-insurance.pdf
                policy_type:
                  type: string
                  example: insurance
                bank_id:
                  type: string
                  example: chase
                use_cache:
                  type: boolean
                  default: true
      responses:
        '200':
          description: Workflow completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowResult'

  # ============================================================================
  # ADMIN API - DEPLOYMENTS
  # ============================================================================

  /api/v1/deployments:
    get:
      tags:
        - Admin - Deployments
      summary: List all deployments
      description: Query deployed rule containers with optional filters
      operationId: listDeployments
      parameters:
        - name: bank_id
          in: query
          schema:
            type: string
        - name: policy_type
          in: query
          schema:
            type: string
        - name: status
          in: query
          schema:
            type: string
            enum: [deploying, running, stopped, failed, unhealthy]
        - name: active_only
          in: query
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: List of deployments
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  total:
                    type: integer
                  deployments:
                    type: array
                    items:
                      $ref: '#/components/schemas/DeploymentInfo'

  /api/v1/deployments/{id}:
    get:
      tags:
        - Admin - Deployments
      summary: Get deployment details
      description: Get detailed information about a specific deployment including statistics
      operationId: getDeployment
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Deployment details
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  deployment:
                    $ref: '#/components/schemas/DeploymentInfo'
                  statistics:
                    type: object
                    properties:
                      total_requests:
                        type: integer
                      successful_requests:
                        type: integer
                      failed_requests:
                        type: integer
                      avg_execution_time_ms:
                        type: number
                      success_rate:
                        type: number

  # ============================================================================
  # SYSTEM
  # ============================================================================

  /api/v1/health:
    get:
      tags:
        - System
      summary: System health check
      description: Check if database and Drools are connected
      operationId: healthCheck
      responses:
        '200':
          description: System healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy, unhealthy]
                  database:
                    type: string
                    enum: [connected, disconnected]
                  drools:
                    type: string
                    enum: [connected, disconnected]
        '503':
          description: System unhealthy

components:
  schemas:
    ContainerInfo:
      type: object
      properties:
        container_id:
          type: string
          example: chase-insurance-underwriting-rules
        bank_id:
          type: string
          example: chase
        policy_type_id:
          type: string
          example: insurance
        endpoint:
          type: string
          example: http://drools-chase-insurance:8080
        status:
          type: string
          enum: [deploying, running, stopped, failed, unhealthy]
        health_status:
          type: string
          enum: [healthy, unhealthy, unknown]
        deployed_at:
          type: string
          format: date-time

    DeploymentInfo:
      type: object
      properties:
        id:
          type: integer
        container_id:
          type: string
        bank_id:
          type: string
        policy_type_id:
          type: string
        endpoint:
          type: string
        status:
          type: string
        health_status:
          type: string
        platform:
          type: string
        version:
          type: integer
        is_active:
          type: boolean
        deployed_at:
          type: string
          format: date-time
        s3_jar_url:
          type: string
        s3_drl_url:
          type: string
        s3_excel_url:
          type: string

    EvaluationResult:
      type: object
      properties:
        status:
          type: string
          example: success
        bank_id:
          type: string
        policy_type:
          type: string
        container_id:
          type: string
        decision:
          type: object
          description: Rule engine decision (format depends on deployed rules)
          example:
            approved: true
            reasons: ["Good credit score", "Stable income"]
            premium_rate: 0.85
        execution_time_ms:
          type: integer
          example: 45

    WorkflowResult:
      type: object
      properties:
        s3_url:
          type: string
        policy_type:
          type: string
        bank_id:
          type: string
        container_id:
          type: string
        status:
          type: string
          enum: [in_progress, completed, failed]
        jar_s3_url:
          type: string
        drl_s3_url:
          type: string
        excel_s3_url:
          type: string
        steps:
          type: object

    Error:
      type: object
      properties:
        status:
          type: string
          example: error
        message:
          type: string
          example: No active rules deployed for bank 'chase' and policy type 'insurance'
